
//Set up state variables first are a few super long ones...
wordList = [
    "the",
    "and",
    "to",
    "of",
    "a",
    "in",
    "is",
    "that",
    "for",
    "I",
    "you",
    "it",
    "with",
    "on",
    "as",
    "are",
    "be",
    "this",
    "was",
    "have",
    "or",
    "at",
    "not",
    "your",
    "from",
    "we",
    "by",
    "will",
    "can",
    "but",
    "they",
    "an",
    "he",
    "all",
    "has",
    "if",
    "their",
    "one",
    "do",
    "more",
    "nt",
    "my",
    "his",
    "so",
    "there",
    "about",
    "which",
    "when",
    "what",
    "out",
    "up",
    "our",
    "who",
    "also",
    "had",
    "time",
    "some",
    "would",
    "were",
    "like",
    "been",
    "just",
    "her",
    "new",
    "other",
    "them",
    "she",
    "people",
    "these",
    "no",
    "get",
    "how",
    "me",
    "into",
    "than",
    "only",
    "its",
    "most",
    "may",
    "any",
    "many",
    "make",
    "then",
    "well",
    "first",
    "very",
    "over",
    "now",
    "could",
    "after",
    "even",
    "because",
    "us",
    "said",
    "good",
    "way",
    "two",
    "should",
    "work",
    "use",
    "through",
    "see",
    "know",
    "did",
    "much",
    "where",
    "years",
    "need",
    "him",
    "back",
    "such",
    "those",
    "being",
    "day",
    "take",
    "while",
    "here",
    "before",
    "does",
    "great",
    "year",
    "go",
    "help",
    "want",
    "really",
    "think",
    "best",
    "life",
    "each",
    "made",
    "right",
    "world",
    "business",
    "home",
    "own",
    "down",
    "still",
    "used",
    "find",
    "around",
    "going",
    "every",
    "both",
    "last",
    "off",
    "too",
    "same",
    "information",
    "little",
    "another",
    "look",
    "few",
    "long",
    "part",
    "since",
    "things",
    "place",
    "am",
    "between",
    "during",
    "different",
    "must",
    "come",
    "using",
    "however",
    "without",
    "high",
    "why",
    "something",
    "online",
    "system",
    "better",
    "three",
    "never",
    "always",
    "love",
    "say",
    "might",
    "next",
    "company",
    "state",
    "number",
    "again",
    "free",
    "lot",
    "under",
    "family",
    "found",
    "within",
    "give",
    "set",
    "school",
    "important",
    "water",
    "able",
    "keep",
    "got",
    "sure",
    "end",
    "money",
    "service",
    "small",
    "put",
    "experience",
    "having",
    "once",
    "available",
    "health",
    "support",
    "often",
    "including",
    "days",
    "away",
    "old",
    "area",
    "feel",
    "read",
    "show",
    "big",
    "against",
    "thing",
    "order",
    "program",
    "though",
    "city",
    "group",
    "services",
    "site",
    "making",
    "course",
    "point",
    "children",
    "times",
    "team",
    "game",
    "along",
    "let",
    "house",
    "today",
    "body",
    "working",
    "case",
    "man",
    "real",
    "provide",
    "care",
    "public",
    "top",
    "looking",
    "several",
    "start",
    "less",
    "process",
    "become",
    "actually",
    "local",
    "together",
    "person",
    "change",
    "book",
    "enough",
    "getting",
    "week",
    "power",
    "until",
    "market",
    "fact",
    "god",
    "food",
    "students",
    "full",
    "women",
    "community",
    "name",
    "second",
    "data",
    "government",
    "says",
    "others",
    "ever",
    "yet",
    "research",
    "done",
    "left",
    "far",
    "large",
    "called",
    "doing",
    "already",
    "development",
    "social",
    "open",
    "possible",
    "side",
    "play",
    "means",
    "needs",
    "try",
    "came",
    "ca",
    "based",
    "hard",
    "thought",
    "products",
    "national",
    "quality",
    "level",
    "live",
    "design",
    "makes",
    "project",
    "line",
    "night",
    "least",
    "whether",
    "job",
    "car",
    "example",
    "include",
    "following",
    "given",
    "website",
    "past",
    "plan",
    "offer",
    "buy",
    "call",
    "went",
    "simply",
    "hand",
    "music",
    "easy",
    "problem",
    "men",
    "country",
    "took",
    "four",
    "members",
    "form",
    "personal",
    "control",
    "energy",
    "room",
    "head",
    "pay",
    "create",
    "run",
    "kind",
    "credit",
    "almost",
    "believe",
    "quite",
    "mind",
    "law",
    "early",
    "comes",
    "states",
    "usually",
    "companies",
    "web",
    "taking",
    "started",
    "later",
    "although",
    "story",
    "per",
    "future",
    "known",
    "someone",
    "across",
    "rather",
    "young",
    "whole",
    "special",
    "everything",
    "months",
    "anything",
    "training",
    "url",
    "bit",
    "seen",
    "product",
    "american",
    "please",
    "management",
    "cost",
    "either",
    "light",
    "university",
    "face",
    "due",
    "nothing",
    "human",
    "event",
    "history",
    "probably",
    "friends",
    "learn",
    "current",
    "tell",
    "general",
    "price",
    "list",
    "type",
    "building",
    "industry",
    "bad",
    "check",
    "everyone",
    "office",
    "idea",
    "internet",
    "news",
    "million",
    "video",
    "among",
    "air",
    "especially",
    "told",
    "results",
    "post",
    "hours",
    "international",
    "center",
    "understand",
    "above",
    "addition",
    "major",
    "education",
    "white",
    "particular",
    "problems",
    "media",
    "according",
    "upon",
    "page",
    "continue",
    "black",
    "study",
    "issues",
    "inside",
    "technology",
    "five",
    "value",
    "further",
    "access",
    "reason",
    "short",
    "true",
    "simple",
    "natural",
    "amount",
    "search",
    "result",
    "taken",
    "main",
    "heart",
    "space",
    "financial",
    "ago",
    "trying",
    "question",
    "living",
    "likely",
    "interest",
    "various",
    "insurance",
    "common",
    "move",
    "child",
    "yourself",
    "report",
    "certain",
    "share",
    "single",
    "close",
    "instead",
    "bring",
    "works",
    "age",
    "s",
    "season",
    "hope",
    "coming",
    "areas",
    "ask",
    "medical",
    "low",
    "games",
    "turn",
    "key",
    "party",
    "add",
    "month",
    "seems",
    "view",
    "fun",
    "matter",
    "words",
    "needed"];
    
colorList = [
    'green', 'red', 'blue', 'yellow', 'black', 'orange', 'pink', 'purple'
];

const l1Nodes = document.querySelectorAll('#l1 > div');
const l2Nodes = document.querySelectorAll('#l2 > div');
const l3Nodes = document.querySelectorAll('#l3 > div');
const l4Nodes = document.querySelectorAll('#l4 > div');
const l5Nodes = document.querySelectorAll('#l5 > div');
const l6Nodes = document.querySelectorAll('#l6 > div');
const l7Nodes = document.querySelectorAll('#l7 > div');
const l8Nodes = document.querySelectorAll('#l8 > div');
const laneList = [l1Nodes, l2Nodes, l3Nodes, l4Nodes, l5Nodes, l6Nodes, l7Nodes, l8Nodes];
const body = document.querySelector('body');
const lane1 = document.querySelector('#l1');
const cityQuestionArea = document.querySelector('#question');
const userAnswerScreen = document.querySelector('#UI');
const backCity = document.querySelector('#backcity');
const spaceBarEl = document.createElement('div');

//set up audio stuff
const bombLaunchSound = [new Audio('/newbomb.wav'), 
    new Audio('/newbomb.wav'), new Audio('/newbomb.wav'),
    new Audio('/newbomb.wav'), new Audio('/newbomb.wav'), 
    new Audio('/newbomb.wav'), new Audio('/newbomb.wav'),  
    new Audio('/newbomb.wav'), new Audio('/newbomb.wav')
    ];
const introLoop = new Audio('/introloop.wav');
const mainLoop = new Audio('/mainloop.wav');
//this solution to this lag when looping audio was found on stackoverflow
introLoop.addEventListener('timeupdate', function() {
    let delay = .30;
    if(this.currentTime > this.duration - delay) {
        this.currentTime = 0;
        mainLoop.play();
        this.pause()
    }
});
mainLoop.addEventListener('timeupdate', function() {
    let delay = .35;
    if(this.currentTime > this.duration - delay) {
        this.currentTime = 0;
        this.play();
    }
});

//setup start menu
spaceBarEl.innerText = "HIT SPACEBAR TO START";
spaceBarEl.style.position = 'fixed';
spaceBarEl.style.top = '42%';
spaceBarEl.style.fontSize = '1.5em';
spaceBarEl.style.width = '100%';
spaceBarEl.style.textAlign = 'center';
body.appendChild(spaceBarEl);

//utility variables and misc.
let gameEnded = false; //died?
let numberOfBombs = 10; //how many successes before win condition
const startSpeed = 80; //initial speed
let speed = startSpeed; //variable speed for level up
let bombList = [];

const bombFunctions = [ //array of functions for creating bombs
    () => { // regular words
        let randWord = wordList[Math.floor(Math.random() * (wordList.length))];
        return {
            word: randWord,
            color: colorList[Math.floor(Math.random() * (colorList.length))],
            question: "Type the word",
            answer: randWord,
            click: false,
        }
    },
    () => { //color mixups
        let randColor = colorList[Math.floor(Math.random() * (colorList.length))];
        let randChoice = Math.floor(Math.random() * 2);
        if (randChoice === 0) {
            return {
                word: colorList[Math.floor(Math.random() * (colorList.length))],
                color: randColor,
                question: "Type the color",
                answer: randColor,
                click: false,
            }
        }
        else {
            return {
                word: randColor,
                color: colorList[Math.floor(Math.random() * (colorList.length))],
                question: "Type the word",
                answer: randColor,
                click: false,
            }
        }
    },
    () => {
        return {
            word: "Click Me!",
            color: colorList[Math.floor(Math.random() * (colorList.length))],
            question: "Click it!",
            answer: undefined,
            click: true,
        }
    }
]

const bombDetails = function(level) {
    let funcIndex = Math.floor(Math.random() * (level + 1));
    if (level > 2) {funcIndex = 2} // just two levels, lol
    return bombFunctions[funcIndex]();
}

const timer = ms => new Promise(res => setTimeout(res, ms)); //master timer
let gameLevel = 0; // which level you're on... 0 = 1, 1 = 2...


class Bomb {
    constructor(word, color, question, answer, click, lane) {
        console.log(click);
        this.word = word;
        this.color = color;
        this.question = question;
        this.answer = answer;
        this.click = click;
        this.lane = lane;
        this.location = 0;
        this.flutter = 0;
        let el = document.createElement('div');
        el.classList.add('bomb');
        el.style.color = this.color;
        el.innerText = this.word;
        this.element = el;
        this.offset = 0;
        this.lane[this.location].appendChild(this.element);
        if (this.click === true) {
            console.log('test');
            this.element.addEventListener('click', () => {
                if (this.element === bombList[0].element) {
                    console.log('ASFASF');
                    view.removeBomb();
                }
            });
        }
    }
    moveDown() {
        // if (!this.element.classList.contains('.destroyed')) {
            this.location += 1;
            this.element.style.top = `${this.location/4}%`;
        if (this.offset === 0) {
            this.offset = parseInt(this.element.offsetLeft);
        }
        if (this.flutter < 10) {
            this.flutter += 1;
            this.offset += .3;
            this.element.style.left = `${this.offset}px`;
        }
        else if (this.flutter >= 10 && this.flutter < 20) {
            this.flutter += 1;
            this.offset -= .3;
            this.element.style.left = `${this.offset}px`;
        }
        else {
            this.flutter = 0;
        }
        // }
    }
}


const controller = {
    grabUserInput: function(keyStroke) {
        if (bombList[0]) {
            if(userAnswerScreen.value === bombList[0].answer) {
                view.removeBomb();
                userAnswerScreen.value = "";
            }

        }
        if (spaceBarEl.style.display !== 'none') {
            if (keyStroke.code === 'Space') {
                spaceBarEl.style.display = 'none';
                userAnswerScreen.value = '';
                mainLoop.currentTime = 0;
                introLoop.currentTime = 0;
                introLoop.play();
                view.toggleFire(false)
            }
        }
    },

    generateRandomLane: function() {
        return laneList[Math.floor(Math.random() * 8)];
    },

    generateNewBomb: function(level) {
        let fromBombDetails = bombDetails(level);
        let bombDeets = {
            word: fromBombDetails.word, //take randomly from bomb details
            color: fromBombDetails.color,
            question: fromBombDetails.question,
            answer: fromBombDetails.answer,
            click: fromBombDetails.click,
        }
        let newBomb = new Bomb(bombDeets.word,bombDeets.color,bombDeets.question, bombDeets.answer, bombDeets.click, controller.generateRandomLane());
        bombList.push(newBomb);
        view.playBombSound();
    },

    increaseBombNumber: function(increaseNum) {
        numberOfBombs += increaseNum;
    },

    nextLevel: function() {
        view.clearBombs();
        view.clearScreen();
        gameLevel += 1;
        if (gameLevel > 2) {gameLevel = 2};
        if (speed > 10) {
            speed -= 10
        }
        controller.increaseBombNumber(10);
        clearInterval(intervalID);
        intervalID = setInterval(running, speed);

    },
}

const view = {
    clearBombs: function() {
        bombList.forEach((bomb) => {
            bomb.element.remove();
        });
        bombList = [];
    },

    clearScreen: function() {
        userAnswerScreen.value = '';
        cityQuestionArea.innerText = '';
    },

    moveBombsDown: function() {
        bombList.forEach((bomb) => {
            bomb.moveDown()
            if (parseFloat(bomb.element.style.top) >= 79) {
                gameEnded = true;
            }
        });

    },
    removeBomb: function() {
        let bombToRemove = bombList.shift();
        bombToRemove.element.remove();
        numberOfBombs -= 1;
        view.showQuestion()
    },
    showQuestion: function() {
        if (bombList[0]) {
            if (bombList[0].question != cityQuestionArea.innerText) {
                cityQuestionArea.display = 'none';
                cityQuestionArea.innerText = bombList[0].question;
                cityQuestionArea.display = 'inline';
            }
        }
    },

    makeFlash: function() {
        if (bombList[0]) {
            if (bombList[0].element.style.borderColor !== 'yellow') {
            bombList[0].element.style.borderColor = 'yellow';
            }
            else {
                bombList[0].element.style.borderColor = 'black';
            }
        }

    },
    playBombSound: function () {
        let soundObj = bombLaunchSound.shift();
        soundObj.play();
        bombLaunchSound.push(soundObj);
    },
    toggleFire: function(hasFire) {
        if (hasFire) {
            backCity.style.background = 'url(/fire.gif)';
            backCity.style.backgroundSize = 'contain';
        }
        else {
            backCity.style.background = 'none';
        }
    }
}

userAnswerScreen.focus();
//hookup UI
userAnswerScreen.addEventListener('keyup', (keyStroke) => {
    controller.grabUserInput(keyStroke);
    });
//keep focus on user screen
userAnswerScreen.addEventListener('blur', ()=> {
    userAnswerScreen.focus();
    });

let staggerBombs = 15;

function running () {
    if (!gameEnded) {
        if (numberOfBombs >= 1) {
            if (spaceBarEl.style.display === 'none') {
                if (staggerBombs === 25) {
                    staggerBombs = 0;
                    controller.generateNewBomb(gameLevel);
        
                    if (bombList[0].question !== cityQuestionArea.innerText) {
                        view.showQuestion()
                    }
                }
                view.moveBombsDown();
                staggerBombs += 1
            }
        else {
            //do nothing
        }
        }
        else {
            controller.nextLevel()
        }
    }
    else {
        mainLoop.pause();
        view.playBombSound();
        spaceBarEl.style.display = 'block';
        view.toggleFire(true);
        view.clearBombs();
        view.clearScreen();
        clearInterval(intervalID);
        speed = startSpeed;
        intervalID = setInterval(running, speed);
        gameEnded = false;
    }

}

// game starts here
let intervalID = setInterval(running, speed);
const flash = setInterval(view.makeFlash, 500);
